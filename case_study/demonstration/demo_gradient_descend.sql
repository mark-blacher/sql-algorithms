-- - this file contains a gradient descend implementation 
--   for l2-regularized logistic regression in PostgreSQL dialect
-- - algorithmically, this SQL implementation corresponds to the 
--   Python version from demo_gradient_descend.py
-- - refer to demo_gradient_descend.py for details

-- - this SQL programming style represents vectors, 
--   matrices with explicit indices i and j (i=row, j=column)
-- - this representation is similar to the coordinate format (COO) in sparse linear algebra
-- - in terms of speed and memory consumption, this representation is inferior 
--   to the interpretation of relations directly as vectors and matrices (without explicit indices)
-- - but a big advantage of using the COO form for linear algebra in SQL is its universality
--   (no dependence in the code on the column names and the number of columns)
WITH RECURSIVE X(i, j, val) AS (
VALUES
  (0::int, 0::int, 5.5::float), (0, 1, 2.4), (0, 2, 1.0),
  (1, 0, 5.4),  (1, 1, 3.0),  (1, 2, 1.0),
  (2, 0, 5.5),  (2, 1, 4.2),  (2, 2, 1.0),
  (3, 0, 5.5),  (3, 1, 2.4),  (3, 2, 1.0),
  (4, 0, 5.0),  (4, 1, 2.3),  (4, 2, 1.0),
  (5, 0, 5.1),  (5, 1, 3.5),  (5, 2, 1.0),
  (6, 0, 5.5),  (6, 1, 3.5),  (6, 2, 1.0),
  (7, 0, 5.8),  (7, 1, 2.7),  (7, 2, 1.0),
  (8, 0, 5.6),  (8, 1, 2.5),  (8, 2, 1.0),
  (9, 0, 6.7),  (9, 1, 3.1),  (9, 2, 1.0),
  (10, 0, 5.8), (10, 1, 2.6), (10, 2, 1.0),
  (11, 0, 5.1), (11, 1, 3.4), (11, 2, 1.0),
  (12, 0, 6.3), (12, 1, 3.3), (12, 2, 1.0),
  (13, 0, 6.9), (13, 1, 3.1), (13, 2, 1.0),
  (14, 0, 6.4), (14, 1, 3.2), (14, 2, 1.0),
  (15, 0, 5.2), (15, 1, 4.1), (15, 2, 1.0),
  (16, 0, 5.4), (16, 1, 3.4), (16, 2, 1.0),
  (17, 0, 5.1), (17, 1, 3.8), (17, 2, 1.0),
  (18, 0, 6.0), (18, 1, 2.9), (18, 2, 1.0),
  (19, 0, 5.4), (19, 1, 3.7), (19, 2, 1.0),
  (20, 0, 4.7), (20, 1, 3.2), (20, 2, 1.0),
  (21, 0, 6.1), (21, 1, 2.8), (21, 2, 1.0),
  (22, 0, 6.2), (22, 1, 2.9), (22, 2, 1.0),
  (23, 0, 6.0), (23, 1, 2.2), (23, 2, 1.0),
  (24, 0, 5.1), (24, 1, 3.8), (24, 2, 1.0),
  (25, 0, 5.0), (25, 1, 3.2), (25, 2, 1.0),
  (26, 0, 5.6), (26, 1, 2.7), (26, 2, 1.0),
  (27, 0, 5.2), (27, 1, 3.5), (27, 2, 1.0),
  (28, 0, 5.1), (28, 1, 3.8), (28, 2, 1.0),
  (29, 0, 4.4), (29, 1, 3.0), (29, 2, 1.0),
  (30, 0, 5.8), (30, 1, 2.7), (30, 2, 1.0), 
  (31, 0, 5.7), (31, 1, 2.8), (31, 2, 1.0),
  (32, 0, 6.5), (32, 1, 2.8), (32, 2, 1.0),
  (33, 0, 5.7), (33, 1, 3.0), (33, 2, 1.0),
  (34, 0, 5.6), (34, 1, 3.0), (34, 2, 1.0),
  (35, 0, 5.0), (35, 1, 3.5), (35, 2, 1.0),
  (36, 0, 5.3), (36, 1, 3.7), (36, 2, 1.0),
  (37, 0, 5.2), (37, 1, 2.7), (37, 2, 1.0),
  (38, 0, 5.1), (38, 1, 3.3), (38, 2, 1.0),
  (39, 0, 4.9), (39, 1, 3.1), (39, 2, 1.0),
  (40, 0, 6.7), (40, 1, 3.1), (40, 2, 1.0),
  (41, 0, 5.5), (41, 1, 2.3), (41, 2, 1.0),
  (42, 0, 6.7), (42, 1, 3.0), (42, 2, 1.0),
  (43, 0, 5.7), (43, 1, 4.4), (43, 2, 1.0),
  (44, 0, 6.0), (44, 1, 2.7), (44, 2, 1.0),
  (45, 0, 4.5), (45, 1, 2.3), (45, 2, 1.0),
  (46, 0, 4.8), (46, 1, 3.0), (46, 2, 1.0),
  (47, 0, 6.1), (47, 1, 3.0), (47, 2, 1.0),
  (48, 0, 5.0), (48, 1, 3.4), (48, 2, 1.0),
  (49, 0, 5.1), (49, 1, 2.5), (49, 2, 1.0),
  (50, 0, 5.0), (50, 1, 3.5), (50, 2, 1.0),
  (51, 0, 5.7), (51, 1, 2.8), (51, 2, 1.0),
  (52, 0, 4.8), (52, 1, 3.4), (52, 2, 1.0),
  (53, 0, 5.0), (53, 1, 3.6), (53, 2, 1.0),
  (54, 0, 6.6), (54, 1, 2.9), (54, 2, 1.0),
  (55, 0, 5.0), (55, 1, 3.3), (55, 2, 1.0),
  (56, 0, 5.1), (56, 1, 3.7), (56, 2, 1.0),
  (57, 0, 6.3), (57, 1, 2.3), (57, 2, 1.0),
  (58, 0, 4.6), (58, 1, 3.1), (58, 2, 1.0),
  (59, 0, 6.4), (59, 1, 2.9), (59, 2, 1.0),
  (60, 0, 4.8), (60, 1, 3.1), (60, 2, 1.0),
  (61, 0, 5.6), (61, 1, 3.0), (61, 2, 1.0),
  (62, 0, 5.9), (62, 1, 3.2), (62, 2, 1.0),
  (63, 0, 4.4), (63, 1, 3.2), (63, 2, 1.0),
  (64, 0, 4.6), (64, 1, 3.2), (64, 2, 1.0),
  (65, 0, 5.5), (65, 1, 2.5), (65, 2, 1.0),
  (66, 0, 4.4), (66, 1, 2.9), (66, 2, 1.0),
  (67, 0, 5.0), (67, 1, 2.0), (67, 2, 1.0),
  (68, 0, 5.1), (68, 1, 3.5), (68, 2, 1.0),
  (69, 0, 5.5), (69, 1, 2.6), (69, 2, 1.0),
  (70, 0, 4.9), (70, 1, 2.4), (70, 2, 1.0),
  (71, 0, 4.6), (71, 1, 3.6), (71, 2, 1.0),
  (72, 0, 5.9), (72, 1, 3.0), (72, 2, 1.0),
  (73, 0, 6.1), (73, 1, 2.9), (73, 2, 1.0),
  (74, 0, 5.0), (74, 1, 3.4), (74, 2, 1.0),
  (75, 0, 5.7), (75, 1, 2.9), (75, 2, 1.0),
  (76, 0, 4.3), (76, 1, 3.0), (76, 2, 1.0),
  (77, 0, 6.2), (77, 1, 2.2), (77, 2, 1.0),
  (78, 0, 6.0), (78, 1, 3.4), (78, 2, 1.0),
  (79, 0, 5.8), (79, 1, 4.0), (79, 2, 1.0),
  (80, 0, 4.7), (80, 1, 3.2), (80, 2, 1.0),
  (81, 0, 5.2), (81, 1, 3.4), (81, 2, 1.0),
  (82, 0, 4.8), (82, 1, 3.4), (82, 2, 1.0),
  (83, 0, 5.7), (83, 1, 3.8), (83, 2, 1.0),
  (84, 0, 5.4), (84, 1, 3.4), (84, 2, 1.0),
  (85, 0, 7.0), (85, 1, 3.2), (85, 2, 1.0),
  (86, 0, 5.0), (86, 1, 3.0), (86, 2, 1.0),
  (87, 0, 4.6), (87, 1, 3.4), (87, 2, 1.0),
  (88, 0, 6.1), (88, 1, 2.8), (88, 2, 1.0),
  (89, 0, 6.8), (89, 1, 2.8), (89, 2, 1.0),
  (90, 0, 4.9), (90, 1, 3.0), (90, 2, 1.0),
  (91, 0, 5.4), (91, 1, 3.9), (91, 2, 1.0),
  (92, 0, 5.6), (92, 1, 2.9), (92, 2, 1.0),
  (93, 0, 5.7), (93, 1, 2.6), (93, 2, 1.0),
  (94, 0, 5.4), (94, 1, 3.9), (94, 2, 1.0),
  (95, 0, 6.6), (95, 1, 3.0), (95, 2, 1.0),
  (96, 0, 4.9), (96, 1, 3.1), (96, 2, 1.0),
  (97, 0, 6.3), (97, 1, 2.5), (97, 2, 1.0),
  (98, 0, 4.8), (98, 1, 3.0), (98, 2, 1.0),
  (99, 0, 4.9), (99, 1, 3.6), (99, 2, 1.0)
), y (i, val) AS (
VALUES
  (0::int, 1.0::float),
  (1, 1.0),
  (2, -1.0),
  (3, 1.0),
  (4, 1.0),
  (5, -1.0),
  (6, -1.0),
  (7, 1.0),
  (8, 1.0),
  (9, 1.0),
  (10, 1.0),
  (11, -1.0),
  (12, 1.0),
  (13, 1.0),
  (14, 1.0),
  (15, -1.0),
  (16, -1.0),
  (17, -1.0),
  (18, 1.0),
  (19, -1.0),
  (20, -1.0),
  (21, 1.0),
  (22, 1.0),
  (23, 1.0),
  (24, -1.0),
  (25, -1.0),
  (26, 1.0),
  (27, -1.0),
  (28, -1.0),
  (29, -1.0),
  (30, 1.0),
  (31, 1.0),
  (32, 1.0),
  (33, 1.0),
  (34, 1.0),
  (35, -1.0),
  (36, -1.0),
  (37, 1.0),
  (38, -1.0),
  (39, -1.0),
  (40, 1.0),
  (41, 1.0),
  (42, 1.0),
  (43, -1.0),
  (44, 1.0),
  (45, -1.0),
  (46, -1.0),
  (47, 1.0),
  (48, -1.0),
  (49, 1.0),
  (50, -1.0),
  (51, 1.0),
  (52, -1.0),
  (53, -1.0),
  (54, 1.0),
  (55, -1.0),
  (56, -1.0),
  (57, 1.0),
  (58, -1.0),
  (59, 1.0),
  (60, -1.0),
  (61, 1.0),
  (62, 1.0),
  (63, -1.0),
  (64, -1.0),
  (65, 1.0),
  (66, -1.0),
  (67, 1.0),
  (68, -1.0),
  (69, 1.0),
  (70, 1.0),
  (71, -1.0),
  (72, 1.0),
  (73, 1.0),
  (74, -1.0),
  (75, 1.0),
  (76, -1.0),
  (77, 1.0),
  (78, 1.0),
  (79, -1.0),
  (80, -1.0),
  (81, -1.0),
  (82, -1.0),
  (83, -1.0),
  (84, -1.0),
  (85, 1.0),
  (86, -1.0),
  (87, -1.0),
  (88, 1.0),
  (89, 1.0),
  (90, -1.0),
  (91, -1.0),
  (92, 1.0),
  (93, 1.0),
  (94, -1.0),
  (95, 1.0),
  (96, -1.0),
  (97, 1.0),
  (98, -1.0),
  (99, -1)
), w_init (i, val) AS (
VALUES (0, 0.0::float), 
       (1, 0.0::float), 
       (2, 0.0::float)
), log_reg(it, i, val) AS (
  SELECT 0, i, val FROM w_init
UNION ALL
  SELECT it + 1, i, val FROM (
    WITH w(it, i, val) AS (
      SELECT it, i, val FROM log_reg
    ), X_dot_w(i, val) AS ( -- X.dot(w)
      SELECT X.i, SUM(X.val * w.val) FROM X, w WHERE X.j = w.i GROUP BY X.i
    ), cse(i, val) AS ( -- np.exp(-(y * X_dot_w))
      SELECT y.i, EXP(-(y.val * X_dot_w.val)) FROM y, X_dot_w WHERE y.i = X_dot_w.i
    ), v(i, val) AS ( -- cse * y / (1 + cse)
      SELECT y.i, cse.val * y.val / (1 + cse.val) FROM cse, y WHERE cse.i = y.i
    ), c_X_T_dot_v(i, val) AS (-- c * X.T.dot(v), c = 2
      SELECT X.j, 2 * SUM(X.val * v.val) FROM X, v WHERE X.i = v.i GROUP BY X.j
    ), g(i, val) AS ( -- w - c_X_T_dot_v
      SELECT w.i, w.val - c_X_T_dot_v.val FROM w, c_X_T_dot_v WHERE w.i = c_X_T_dot_v.i
    ) SELECT it, w.i, w.val - 0.001 * g.val FROM w, g WHERE w.i = g.i -- w - alpha * g, alpha=0.001
  ) AS w(it, i, val) WHERE it < 100 -- specify the number of iterations here
), w(i, val) AS (
  SELECT i, val from log_reg WHERE it = (SELECT MAX(it) FROM log_reg)
), probs(i, val) AS ( -- 1 / (1 + np.exp(-np.dot(X, w)))
  SELECT X.i, 1 / (1 + EXP(-SUM(X.val * w.val))) FROM X, w WHERE X.j = w.i GROUP BY X.i
), predicted(i, val) AS ( -- np.where(probs >= 0.5, 1, -1)
  SELECT i, CASE WHEN val >= 0.5 THEN 1.0::float ELSE -1.0::float END FROM probs
), accuracy(val) AS ( -- sum(y_predicted == y) / y.shape[0])
  SELECT SUM(1)::float / (SELECT COUNT(*) FROM y) FROM y, predicted WHERE y.i = predicted.i AND y.val = predicted.val
), pretty_print(result, values) AS (
  SELECT 'w:', ARRAY_TO_STRING(ARRAY(SELECT val FROM w ORDER BY i), ', ') UNION ALL
  SELECT 'accuracy:', (SELECT val::text FROM accuracy)
) SELECT * FROM pretty_print;

